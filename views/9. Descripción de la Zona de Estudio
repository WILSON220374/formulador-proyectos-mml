import streamlit as st
import os
import uuid
from PIL import Image
from session_state import inicializar_session, guardar_datos_nube

# 1. Asegurar persistencia y memoria
inicializar_session()

# --- CONFIGURACI√ìN DE ALMACENAMIENTO ---
# Aseguramos que exista la estructura de datos para esta hoja
if 'descripcion_zona' not in st.session_state:
    st.session_state['descripcion_zona'] = {
        # Localizaci√≥n
        "departamento": "", "municipio": "", "vereda_corregimiento": "", "ubicacion_especifica": "",
        # Caracter√≠sticas F√≠sicas
        "clima_temperatura": "", "altitud": "", "topografia_suelos": "", "hidrografia": "",
        # Aspectos Socioambientales
        "ecosistemas_clave": "", "uso_suelo": "", "poblacion_beneficiaria": "",
        "actividades_economicas": "", "vias_acceso": "", "infraestructura_servicios": "",
        # Rutas de Im√°genes (Se guardan los paths locales)
        "ruta_mapa": None, "ruta_foto1": None, "ruta_foto2": None,
        # Pies de Foto
        "pie_mapa": "", "pie_foto1": "", "pie_foto2": ""
    }

# Referencia corta para facilitar el c√≥digo
zona_data = st.session_state['descripcion_zona']

# Carpeta para guardar im√°genes subidas
UPLOAD_FOLDER = 'uploads'
if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

# --- DISE√ëO PROFESIONAL (CSS) ---
st.markdown("""
    <style>
    .block-container { padding-bottom: 5rem !important; }
    .titulo-seccion { font-size: 30px !important; font-weight: 800 !important; color: #1E3A8A; margin-bottom: 5px; }
    .subtitulo-gris { font-size: 16px !important; color: #666; margin-bottom: 25px; }

    /* Estilo para subt√≠tulos de bloques de formulario */
    .form-header {
        color: #1E3A8A;
        font-weight: 700;
        font-size: 1.1rem;
        margin-top: 20px;
        margin-bottom: 10px;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 5px;
    }

    /* Contenedor de imagen para visualizaci√≥n limpia */
    .img-preview-container {
        border: 1px solid #e2e8f0;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        background-color: #f8fafc;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .main .stButton button {
        border: none !important;
        background: transparent !important;
        color: #ef4444 !important;
        font-size: 1.2rem !important;
        margin-top: -10px !important;
    }
    </style>
""", unsafe_allow_html=True)

# --- ENCABEZADO ---
col_t, col_img_head = st.columns([4, 1], vertical_alignment="center")
with col_t:
    st.markdown('<div class="titulo-seccion">üó∫Ô∏è 9. Descripci√≥n General de la Zona de Estudio</div>', unsafe_allow_html=True)
    st.markdown('<div class="subtitulo-gris">Caracterizaci√≥n geogr√°fica, ambiental y socioecon√≥mica del √°rea de intervenci√≥n.</div>', unsafe_allow_html=True)
    
    # Calcular progreso basado en campos de texto llenos
    campos_texto = [v for k, v in zona_data.items() if isinstance(v, str) and not k.startswith('ruta') and not k.startswith('pie')]
    campos_llenos = len([c for c in campos_texto if c.strip() != ""])
    total_campos = len(campos_texto)
    progreso = campos_llenos / total_campos if total_campos > 0 else 0
    st.progress(progreso)

with col_img_head:
    if os.path.exists("unnamed.jpg"): st.image("unnamed.jpg", use_container_width=True)

st.divider()

# --- FUNCIONES DE ACTUALIZACI√ìN SEGURA (Persistencia Instant√°nea) ---
# Se crea una funci√≥n por campo para asegurar que el estado se actualice correctamente al escribir
def update_field(key):
    # El valor viene del session_state temporal del input widget
    temp_key = f"temp_{key}"
    if temp_key in st.session_state:
        st.session_state['descripcion_zona'][key] = st.session_state[temp_key]
        guardar_datos_nube()

# --- FUNCI√ìN PARA MANEJAR SUBIDA DE IM√ÅGENES ---
def manejar_subida_imagen(uploaded_file, tipo_imagen_key):
    if uploaded_file is not None:
        # Generar nombre √∫nico para evitar sobreescrituras
        file_ext = os.path.splitext(uploaded_file.name)[1]
        unique_filename = f"{tipo_imagen_key}_{uuid.uuid4()}{file_ext}"
        file_path = os.path.join(UPLOAD_FOLDER, unique_filename)
        
        # Guardar el archivo f√≠sicamente en el disco
        with open(file_path, "wb") as f:
            f.write(uploaded_file.getbuffer())
        
        # Borrar imagen anterior si exist√≠a para no llenar el disco
        ruta_anterior = st.session_state['descripcion_zona'].get(f"ruta_{tipo_imagen_key}")
        if ruta_anterior and os.path.exists(ruta_anterior):
            try: os.remove(ruta_anterior)
            except: pass # Ignorar errores al borrar si el archivo estaba ocupado

        # Actualizar la ruta en la memoria del proyecto
        st.session_state['descripcion_zona'][f"ruta_{tipo_imagen_key}"] = file_path
        guardar_datos_nube()
        st.toast(f"‚úÖ {tipo_imagen_key.replace('_', ' ').title()} cargada correctamente.")

# --- FORMULARIO DE DILIGENCIAMIENTO ---

# BLOQUE 1: LOCALIZACI√ìN
st.markdown('<div class="form-header">üìç 1. Localizaci√≥n Geogr√°fica</div>', unsafe_allow_html=True)
c1, c2, c3 = st.columns(3)
with c1: st.text_input("Departamento:", value=zona_data['departamento'], key="temp_departamento", on_change=update_field, args=("departamento",))
with c2: st.text_input("Municipio(s):", value=zona_data['municipio'], key="temp_municipio", on_change=update_field, args=("municipio",))
with c3: st.text_input("Vereda / Corregimiento / Barrio:", value=zona_data['vereda_corregimiento'], key="temp_vereda_corregimiento", on_change=update_field, args=("vereda_corregimiento",))
st.text_area("Descripci√≥n de la Ubicaci√≥n Espec√≠fica (L√≠mites, puntos de referencia):", value=zona_data['ubicacion_especifica'], key="temp_ubicacion_especifica", on_change=update_field, args=("ubicacion_especifica",), height=80)

# BLOQUE 2: CARACTER√çSTICAS F√çSICAS Y AMBIENTALES
st.markdown('<div class="form-header">‚õ∞Ô∏è 2. Caracter√≠sticas F√≠sicas y Ambientales</div>', unsafe_allow_html=True)
c1, c2 = st.columns(2)
with c1:
    st.text_input("Clima y Temperatura Promedio:", value=zona_data['clima_temperatura'], key="temp_clima_temperatura", on_change=update_field, args=("clima_temperatura",))
    st.text_area("Topograf√≠a y Tipos de Suelo:", value=zona_data['topografia_suelos'], key="temp_topografia_suelos", on_change=update_field, args=("topografia_suelos",), height=100)
    st.text_input("Ecosistemas Estrat√©gicos Clave:", value=zona_data['ecosistemas_clave'], key="temp_ecosistemas_clave", on_change=update_field, args=("ecosistemas_clave",))
with c2:
    st.text_input("Rango de Altitud (m.s.n.m.):", value=zona_data['altitud'], key="temp_altitud", on_change=update_field, args=("altitud",))
    st.text_area("Hidrograf√≠a (Fuentes de agua cercanas):", value=zona_data['hidrografia'], key="temp_hidrografia", on_change=update_field, args=("hidrografia",), height=100)
    st.text_input("Uso Actual del Suelo:", value=zona_data['uso_suelo'], key="temp_uso_suelo", on_change=update_field, args=("uso_suelo",))

# BLOQUE 3: ASPECTOS SOCIOECON√ìMICOS E INFRAESTRUCTURA
st.markdown('<div class="form-header">üë• 3. Aspectos Socioecon√≥micos e Infraestructura</div>', unsafe_allow_html=True)
st.text_area("Descripci√≥n de la Poblaci√≥n Beneficiaria (Caracter√≠sticas demogr√°ficas, culturales):", value=zona_data['poblacion_beneficiaria'], key="temp_poblacion_beneficiaria", on_change=update_field, args=("poblacion_beneficiaria",), height=100)
c1, c2 = st.columns(2)
with c1:
    st.text_area("Principales Actividades Econ√≥micas:", value=zona_data['actividades_economicas'], key="temp_actividades_economicas", on_change=update_field, args=("actividades_economicas",), height=100)
with c2:
    st.text_area("V√≠as de Acceso y Estado:", value=zona_data['vias_acceso'], key="temp_vias_acceso", on_change=update_field, args=("vias_acceso",), height=100)
st.text_area("Infraestructura y Servicios P√∫blicos Disponibles (Agua, luz, conectividad, salud, educaci√≥n):", value=zona_data['infraestructura_servicios'], key="temp_infraestructura_servicios", on_change=update_field, args=("infraestructura_servicios",), height=80)

st.divider()

# BLOQUE 4: EVIDENCIA GR√ÅFICA (MAPAS Y FOTOS)
st.markdown('<div class="form-header">üì∏ 4. Evidencia Gr√°fica de la Zona</div>', unsafe_allow_html=True)
st.info("Cargue las im√°genes correspondientes. Se guardar√°n autom√°ticamente en el proyecto.")

col_mapa, col_foto1, col_foto2 = st.columns(3)

# --- MAPA DE UBICACI√ìN ---
with col_mapa:
    st.markdown("**Mapa de Ubicaci√≥n**")
    uploaded_mapa = st.file_uploader("Subir Mapa", type=['png', 'jpg', 'jpeg'], key="up_mapa", label_visibility="collapsed")
    if uploaded_mapa:
        manejar_subida_imagen(uploaded_mapa, "mapa")
        st.rerun() # Recargar para mostrar la imagen guardada
    
    st.markdown('<div class="img-preview-container">', unsafe_allow_html=True)
    if zona_data.get("ruta_mapa") and os.path.exists(zona_data["ruta_mapa"]):
        st.image(zona_data["ruta_mapa"], use_container_width=True)
    else:
        st.markdown('<span style="color:#ccc;">Vista previa del Mapa</span>', unsafe_allow_html=True)
    st.markdown('</div>', unsafe_allow_html=True)
    st.text_input("Pie de foto (Mapa):", value=zona_data['pie_mapa'], key="temp_pie_mapa", on_change=update_field, args=("pie_mapa",))

# --- FOTO 1 ---
with col_foto1:
    st.markdown("**Fotograf√≠a 1 (General)**")
    uploaded_foto1 = st.file_uploader("Subir Foto 1", type=['png', 'jpg', 'jpeg'], key="up_foto1", label_visibility="collapsed")
    if uploaded_foto1:
        manejar_subida_imagen(uploaded_foto1, "foto1")
        st.rerun()

    st.markdown('<div class="img-preview-container">', unsafe_allow_html=True)
    if zona_data.get("ruta_foto1") and os.path.exists(zona_data["ruta_foto1"]):
        st.image(zona_data["ruta_foto1"], use_container_width=True)
    else:
        st.markdown('<span style="color:#ccc;">Vista previa Foto 1</span>', unsafe_allow_html=True)
    st.markdown('</div>', unsafe_allow_html=True)
    st.text_input("Pie de foto (Foto 1):", value=zona_data['pie_foto1'], key="temp_pie_foto1", on_change=update_field, args=("pie_foto1",))

# --- FOTO 2 ---
with col_foto2:
    st.markdown("**Fotograf√≠a 2 (Espec√≠fica)**")
    uploaded_foto2 = st.file_uploader("Subir Foto 2", type=['png', 'jpg', 'jpeg'], key="up_foto2", label_visibility="collapsed")
    if uploaded_foto2:
        manejar_subida_imagen(uploaded_foto2, "foto2")
        st.rerun()

    st.markdown('<div class="img-preview-container">', unsafe_allow_html=True)
    if zona_data.get("ruta_foto2") and os.path.exists(zona_data["ruta_foto2"]):
        st.image(zona_data["ruta_foto2"], use_container_width=True)
    else:
        st.markdown('<span style="color:#ccc;">Vista previa Foto 2</span>', unsafe_allow_html=True)
    st.markdown('</div>', unsafe_allow_html=True)
    st.text_input("Pie de foto (Foto 2):", value=zona_data['pie_foto2'], key="temp_pie_foto2", on_change=update_field, args=("pie_foto2",))

st.divider()
st.success("‚úÖ Toda la informaci√≥n e im√°genes se guardan autom√°ticamente al ser ingresadas.")
